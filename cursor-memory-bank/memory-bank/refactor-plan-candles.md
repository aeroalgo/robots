# –ü–ª–∞–Ω —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –º–æ–¥—É–ª—è candles

**–î–∞—Ç–∞**: 2025-01-27
**–ú–æ–¥—É–ª—å**: `src/candles/`
**–û—Å–Ω–æ–≤–∞–Ω –Ω–∞**: `refactor-analysis-candles.md`

## üéØ –¶–ï–õ–ò –†–ï–§–ê–ö–¢–û–†–ò–ù–ì–ê

1. –£–ª—É—á—à–∏—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –∏ —Å–æ–±–ª—é–¥–µ–Ω–∏–µ SOLID –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤
2. –°–Ω–∏–∑–∏—Ç—å —Ü–∏–∫–ª–∏—á–µ—Å–∫—É—é —Å–ª–æ–∂–Ω–æ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏–π
3. –£—Å—Ç—Ä–∞–Ω–∏—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
4. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (—É–±—Ä–∞—Ç—å –∏–∑–±—ã—Ç–æ—á–Ω—ã–µ –∞–ª–ª–æ–∫–∞—Ü–∏–∏)
5. –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏
6. –£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫

## üìã –ü–õ–ê–ù –†–ï–ê–õ–ò–ó–ê–¶–ò–ò –ü–û –ü–†–ò–û–†–ò–¢–ï–¢–ê–ú

### üî¥ Critical Priority

#### 1. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤ (TDD –ø–æ–¥—Ö–æ–¥)

**–ü—Ä–æ–±–ª–µ–º–∞**: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ç–µ—Å—Ç–æ–≤ (0% –ø–æ–∫—Ä—ã—Ç–∏–µ)

**–†–µ—à–µ–Ω–∏–µ**:
- –ù–∞–ø–∏—Å–∞—Ç—å unit-—Ç–µ—Å—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–æ–¥—É–ª—è –ü–ï–†–ï–î —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–æ–º
- –ü–æ–∫—Ä—ã—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏, –≥—Ä–∞–Ω–∏—á–Ω—ã–µ —Å–ª—É—á–∞–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å TDD: —Ç–µ—Å—Ç—ã ‚Üí —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ—Å—Ç–æ–≤

**–®–∞–≥–∏**:
1. –°–æ–∑–¥–∞—Ç—å `#[cfg(test)] mod tests` –≤ –∫–∞–∂–¥–æ–º —Ñ–∞–π–ª–µ
2. –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è `BarType` –∏ `BarTypeConfig`
3. –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ `BarBuilder`
4. –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è `TimeFrameAggregator`
5. –ù–∞–ø–∏—Å–∞—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**: 80%+ –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏

#### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞**: `ratio as usize` –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è

**–í–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ—à–µ–Ω–∏—è**:

**–í–∞—Ä–∏–∞–Ω—Ç 1**: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å –≤–æ–∑–≤—Ä–∞—Ç–æ–º –æ—à–∏–±–∫–∏
```rust
let ratio = aggregated_frame.metadata.aggregation_ratio as usize;
if ratio > usize::MAX as f64 {
    return Err(TimeFrameAggregationError::InvalidAggregation(...));
}
```

**–í–∞—Ä–∏–∞–Ω—Ç 2**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `try_into()`
```rust
let ratio: usize = aggregated_frame.metadata.aggregation_ratio
    .try_into()
    .map_err(|_| TimeFrameAggregationError::InvalidAggregation(...))?;
```

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ–¥—Ö–æ–¥**: –í–∞—Ä–∏–∞–Ω—Ç 2 (–±–æ–ª–µ–µ –∏–¥–∏–æ–º–∞—Ç–∏—á–Ω—ã–π –¥–ª—è Rust)

**–®–∞–≥–∏**:
1. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –≤ `expand()`
2. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –≤ `build_compressed_frame_from_source()`
3. –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è –≥—Ä–∞–Ω–∏—á–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤

#### 3. –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö –∞–ª–ª–æ–∫–∞—Ü–∏–π

**–ü—Ä–æ–±–ª–µ–º–∞**: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –≥–æ—Ä—è—á–∏—Ö –ø—É—Ç—è—Ö

**–í–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ—à–µ–Ω–∏—è**:

**–í–∞—Ä–∏–∞–Ω—Ç 1**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–æ–∫ –≤–µ–∑–¥–µ –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ
- –ó–∞–º–µ–Ω–∏—Ç—å `symbol.clone()` –Ω–∞ `&symbol` –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `Cow<Symbol>` –¥–ª—è —É—Å–ª–æ–≤–Ω–æ–≥–æ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

**–í–∞—Ä–∏–∞–Ω—Ç 2**: –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `Vec::with_capacity()` —Å —Ç–æ—á–Ω—ã–º —Ä–∞–∑–º–µ—Ä–æ–º
- –ò–∑–±–µ–≥–∞—Ç—å –ø–µ—Ä–µ–∞–ª–ª–æ–∫–∞—Ü–∏–π

**–í–∞—Ä–∏–∞–Ω—Ç 3**: –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä
- –°–æ–∑–¥–∞—Ç—å –ø—É–ª `Quote` –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `SmallVec` –¥–ª—è –Ω–µ–±–æ–ª—å—à–∏—Ö –∫–æ–ª–ª–µ–∫—Ü–∏–π

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ–¥—Ö–æ–¥**: –ö–æ–º–±–∏–Ω–∞—Ü–∏—è –í–∞—Ä–∏–∞–Ω—Ç–æ–≤ 1 –∏ 2

**–®–∞–≥–∏**:
1. –ó–∞–º–µ–Ω–∏—Ç—å `symbol.clone()` –Ω–∞ —Å—Å—ã–ª–∫–∏ –≤ builders
2. –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –≤—ã–¥–µ–ª—è—Ç—å –ø–∞–º—è—Ç—å —Å —Ç–æ—á–Ω—ã–º —Ä–∞–∑–º–µ—Ä–æ–º
3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `Vec` –≤–º–µ—Å—Ç–æ `HashMap` –¥–ª—è `source_indices`
4. –î–æ–±–∞–≤–∏—Ç—å –±–µ–Ω—á–º–∞—Ä–∫–∏ –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è —É–ª—É—á—à–µ–Ω–∏–π

#### 4. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

**–ü—Ä–æ–±–ª–µ–º–∞**: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

**–†–µ—à–µ–Ω–∏–µ**:
- –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤ –Ω–∞—á–∞–ª–µ –∫–∞–∂–¥–æ–≥–æ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å –ø—É—Å—Ç—ã–µ `QuoteFrame`
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- –í–æ–∑–≤—Ä–∞—â–∞—Ç—å –ø–æ–Ω—è—Ç–Ω—ã–µ –æ—à–∏–±–∫–∏

**–®–∞–≥–∏**:
1. –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ `validate()` –≤ `TimeFrameAggregator`
2. –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤ –∫–∞–∂–¥—ã–π `BarBuilder`
3. –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏

### üü† High Priority

#### 5. –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ TimeFrameAggregator (—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏)

**–ü—Ä–æ–±–ª–µ–º–∞**: –ù–∞—Ä—É—à–µ–Ω–∏–µ SRP - —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏

**–í–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ—à–µ–Ω–∏—è**:

**–í–∞—Ä–∏–∞–Ω—Ç 1**: –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
```rust
pub struct TimeFrameValidator;
pub struct TimeFrameConverter;
pub struct TimeFrameAggregator;
pub struct TimeFrameExpander;
```

**–í–∞—Ä–∏–∞–Ω—Ç 2**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–æ–¥—É–ª–µ–π
- –°–æ–∑–¥–∞—Ç—å –ø–æ–¥–º–æ–¥—É–ª–∏: `validator.rs`, `converter.rs`, `expander.rs`
- –û—Å—Ç–∞–≤–∏—Ç—å `aggregator.rs` –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

**–í–∞—Ä–∏–∞–Ω—Ç 3**: Trait-based –ø–æ–¥—Ö–æ–¥
```rust
trait TimeFrameValidator { ... }
trait TimeFrameConverter { ... }
trait TimeFrameExpander { ... }
```

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ–¥—Ö–æ–¥**: –í–∞—Ä–∏–∞–Ω—Ç 2 (–ª—É—á—à–∏–π –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –º–æ–¥—É–ª—å–Ω–æ—Å—Ç—å—é –∏ –ø—Ä–æ—Å—Ç–æ—Ç–æ–π)

**–®–∞–≥–∏**:
1. –°–æ–∑–¥–∞—Ç—å `aggregator/validator.rs` –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
2. –°–æ–∑–¥–∞—Ç—å `aggregator/converter.rs` –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤
3. –°–æ–∑–¥–∞—Ç—å `aggregator/expander.rs` –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
4. –û–±–Ω–æ–≤–∏—Ç—å `aggregator.rs` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–æ–≤—ã—Ö –º–æ–¥—É–ª–µ–π
5. –û–±–Ω–æ–≤–∏—Ç—å —Ç–µ—Å—Ç—ã

#### 6. –°–Ω–∏–∂–µ–Ω–∏–µ —Ü–∏–∫–ª–∏—á–µ—Å–∫–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏

**–ü—Ä–æ–±–ª–µ–º–∞**: –§—É–Ω–∫—Ü–∏–∏ —Å –≤—ã—Å–æ–∫–æ–π —Ü–∏–∫–ª–∏—á–µ—Å–∫–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç—å—é (>10)

**–í–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ—à–µ–Ω–∏—è**:

**–í–∞—Ä–∏–∞–Ω—Ç 1**: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –º–µ—Ç–æ–¥–æ–≤
- –†–∞–∑–±–∏—Ç—å –¥–ª–∏–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ –º–µ–Ω—å—à–∏–µ –º–µ—Ç–æ–¥—ã
- –ö–∞–∂–¥—ã–π –º–µ—Ç–æ–¥ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –æ–¥–Ω—É –∑–∞–¥–∞—á—É

**–í–∞—Ä–∏–∞–Ω—Ç 2**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–∞ Strategy
- –°–æ–∑–¥–∞—Ç—å —Ä–∞–∑–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å match –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏

**–í–∞—Ä–∏–∞–Ω—Ç 3**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–∞–Ω–Ω–∏—Ö –≤–æ–∑–≤—Ä–∞—Ç–æ–≤
- –£–ø—Ä–æ—Å—Ç–∏—Ç—å —É—Å–ª–æ–≤–∏—è —á–µ—Ä–µ–∑ early returns
- –£–±—Ä–∞—Ç—å –≤–ª–æ–∂–µ–Ω–Ω—ã–µ if

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ–¥—Ö–æ–¥**: –ö–æ–º–±–∏–Ω–∞—Ü–∏—è –í–∞—Ä–∏–∞–Ω—Ç–æ–≤ 1 –∏ 3

**–®–∞–≥–∏**:
1. –†–∞–∑–±–∏—Ç—å `expand()` –Ω–∞ –º–µ—Ç–æ–¥—ã:
   - `expand_with_source_indices()`
   - `expand_without_source_indices()`
   - `create_expanded_quote()`
2. –†–∞–∑–±–∏—Ç—å `build_compressed_frame_from_source()` –Ω–∞ –º–µ—Ç–æ–¥—ã:
   - `collect_candles_for_bar()`
   - `create_aggregated_candle()`
3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å early returns –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è —É—Å–ª–æ–≤–∏–π
4. –û–±–Ω–æ–≤–∏—Ç—å —Ç–µ—Å—Ç—ã

#### 7. –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞

**–ü—Ä–æ–±–ª–µ–º–∞**: –ü–æ–≤—Ç–æ—Ä—è—é—â–∞—è—Å—è –ª–æ–≥–∏–∫–∞ –≤ builders

**–í–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ—à–µ–Ω–∏—è**:

**–í–∞—Ä–∏–∞–Ω—Ç 1**: Helper –º–µ—Ç–æ–¥—ã –≤ trait
```rust
trait BarBuilder {
    fn build_from_quotes(&mut self, ...) -> Result<QuoteFrame, BarBuilderError>;
    
    // Helper methods
    fn create_quote(&self, ...) -> Quote { ... }
    fn update_high_low(&self, bar: &mut Quote, quote: &Quote) { ... }
}
```

**–í–∞—Ä–∏–∞–Ω—Ç 2**: –û–±—â–∏–π –±–∞–∑–æ–≤—ã–π builder
```rust
struct BaseBarBuilder { ... }
impl BaseBarBuilder {
    fn create_quote(&self, ...) -> Quote { ... }
    fn update_high_low(&self, ...) { ... }
}
```

**–í–∞—Ä–∏–∞–Ω—Ç 3**: –ú–∞–∫—Ä–æ—Å—ã –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–∞
```rust
macro_rules! impl_bar_builder_helpers { ... }
```

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ–¥—Ö–æ–¥**: –í–∞—Ä–∏–∞–Ω—Ç 1 (–Ω–∞–∏–±–æ–ª–µ–µ –≥–∏–±–∫–∏–π)

**–®–∞–≥–∏**:
1. –î–æ–±–∞–≤–∏—Ç—å default –º–µ—Ç–æ–¥—ã –≤ `BarBuilder` trait:
   - `create_quote()`
   - `update_high_low()`
   - `finalize_bar()`
2. –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏—Ç—å builders –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è helper –º–µ—Ç–æ–¥–æ–≤
3. –û–±–Ω–æ–≤–∏—Ç—å —Ç–µ—Å—Ç—ã

#### 8. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä –¥–∞–Ω–Ω—ã—Ö

**–ü—Ä–æ–±–ª–µ–º–∞**: `HashMap<usize, Vec<usize>>` –≤–º–µ—Å—Ç–æ `Vec<Vec<usize>>`

**–†–µ—à–µ–Ω–∏–µ**:
- –ó–∞–º–µ–Ω–∏—Ç—å `HashMap` –Ω–∞ `Vec` –¥–ª—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `Vec::with_capacity()` –¥–ª—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –≤—ã–¥–µ–ª–µ–Ω–∏—è
- –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞

**–®–∞–≥–∏**:
1. –ò–∑–º–µ–Ω–∏—Ç—å `source_indices` –Ω–∞ `Vec<Vec<usize>>`
2. –û–±–Ω–æ–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã –¥–æ—Å—Ç—É–ø–∞
3. –û–±–Ω–æ–≤–∏—Ç—å —Ç–µ—Å—Ç—ã

#### 9. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∏–∑–∞—Ü–∏–∏

**–ü—Ä–æ–±–ª–µ–º–∞**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `Box<dyn BarBuilder>` —Å–æ–∑–¥–∞–µ—Ç overhead

**–í–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ—à–µ–Ω–∏—è**:

**–í–∞—Ä–∏–∞–Ω—Ç 1**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ enum
```rust
pub enum BarBuilderEnum {
    Range(RangeBarBuilder),
    Volume(VolumeBarBuilder),
    ...
}
```

**–í–∞—Ä–∏–∞–Ω—Ç 2**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ generics
- –°–¥–µ–ª–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ generic –Ω–∞–¥ —Ç–∏–ø–∞–º–∏ builders
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞—Ç–∏—á–µ—Å–∫—É—é –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∏–∑–∞—Ü–∏—é

**–í–∞—Ä–∏–∞–Ω—Ç 3**: –û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å (–µ—Å–ª–∏ overhead –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª–µ–Ω)
- –ò–∑–º–µ—Ä–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- –û—Å—Ç–∞–≤–∏—Ç—å –µ—Å–ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ <5%

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ–¥—Ö–æ–¥**: –í–∞—Ä–∏–∞–Ω—Ç 1 (–ª—É—á—à–∏–π –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –∏ –≥–∏–±–∫–æ—Å—Ç—å—é)

**–®–∞–≥–∏**:
1. –°–æ–∑–¥–∞—Ç—å `BarBuilderEnum`
2. –û–±–Ω–æ–≤–∏—Ç—å `BarBuilderFactory` –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ enum
3. –î–æ–±–∞–≤–∏—Ç—å –±–µ–Ω—á–º–∞—Ä–∫–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
4. –û–±–Ω–æ–≤–∏—Ç—å —Ç–µ—Å—Ç—ã

### üü° Medium Priority

#### 10. –£–ª—É—á—à–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

**–ü—Ä–æ–±–ª–µ–º–∞**: –ü–æ—Ç–µ—Ä—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –æ—à–∏–±–æ–∫

**–†–µ—à–µ–Ω–∏–µ**:
- –î–æ–±–∞–≤–∏—Ç—å —Ü–µ–ø–æ—á–∫—É –æ—à–∏–±–æ–∫ —á–µ—Ä–µ–∑ `source`
- –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –æ—à–∏–±–∫–∏
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `anyhow::Context` –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

**–®–∞–≥–∏**:
1. –û–±–Ω–æ–≤–∏—Ç—å `TimeFrameAggregationError` –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ `source`
2. –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
3. –û–±–Ω–æ–≤–∏—Ç—å —Ç–µ—Å—Ç—ã

#### 11. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

**–ü—Ä–æ–±–ª–µ–º–∞**: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ rustdoc –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤

**–†–µ—à–µ–Ω–∏–µ**:
- –î–æ–±–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –¥–ª—è –≤—Å–µ—Ö –ø—É–±–ª–∏—á–Ω—ã—Ö API
- –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- –î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫–∏ –æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

**–®–∞–≥–∏**:
1. –î–æ–±–∞–≤–∏—Ç—å rustdoc –¥–ª—è –≤—Å–µ—Ö –ø—É–±–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∏ –º–µ—Ç–æ–¥–æ–≤
2. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
3. –û–±–Ω–æ–≤–∏—Ç—å README –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ

### üü¢ Low Priority

#### 12. –ú–µ–ª–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `const` –¥–ª—è –∫–æ–Ω—Å—Ç–∞–Ω—Ç
- –£–ª—É—á—à–∏—Ç—å –∏–º–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≥–¥–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
- –î–æ–±–∞–≤–∏—Ç—å `#[inline]` –¥–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö hot-path —Ñ—É–Ω–∫—Ü–∏–π

## üìä –û–ñ–ò–î–ê–ï–ú–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´

### –ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞
- **–ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏**: 0% ‚Üí 80%+
- **–¶–∏–∫–ª–∏—á–µ—Å–∫–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å**: ~8 ‚Üí ~5
- **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞**: –í—ã—Å–æ–∫–æ–µ ‚Üí –ù–∏–∑–∫–æ–µ
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: +20-30% (–∑–∞ —Å—á–µ—Ç —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –∞–ª–ª–æ–∫–∞—Ü–∏–π)

### –£–ª—É—á—à–µ–Ω–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
- ‚úÖ –°–æ–±–ª—é–¥–µ–Ω–∏–µ SOLID –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤
- ‚úÖ –ú–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- ‚úÖ –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∫–æ–¥
- ‚úÖ –ü–æ–Ω—è—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

## üîÑ –ü–û–†–Ø–î–û–ö –í–´–ü–û–õ–ù–ï–ù–ò–Ø

1. **–§–∞–∑–∞ 1: –¢–µ—Å—Ç—ã (Critical)**
   - –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π
   - –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç

2. **–§–∞–∑–∞ 2: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (Critical)**
   - –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ
   - –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é
   - –£—Å—Ç—Ä–∞–Ω–∏—Ç—å –∏–∑–±—ã—Ç–æ—á–Ω—ã–µ –∞–ª–ª–æ–∫–∞—Ü–∏–∏

3. **–§–∞–∑–∞ 3: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (High)**
   - –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ `TimeFrameAggregator`
   - –°–Ω–∏–∂–µ–Ω–∏–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
   - –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è

4. **–§–∞–∑–∞ 4: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (High)**
   - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä –¥–∞–Ω–Ω—ã—Ö
   - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∏–∑–∞—Ü–∏–∏

5. **–§–∞–∑–∞ 5: –£–ª—É—á—à–µ–Ω–∏—è (Medium/Low)**
   - –£–ª—É—á—à–µ–Ω–∏–µ –æ—à–∏–±–æ–∫
   - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
   - –ú–µ–ª–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

## ‚úÖ –ö–†–ò–¢–ï–†–ò–ò –£–°–ü–ï–•–ê

- –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
- –ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏ >80%
- –¶–∏–∫–ª–∏—á–µ—Å–∫–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å <10 –¥–ª—è –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π
- –ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞
- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É–ª—É—á—à–µ–Ω–∞ –Ω–∞ 20%+
- –ö–æ–¥ –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ–ª–Ω–∞—è
