# Система метрик оценки торговых стратегий

## Обзор

Система метрик предназначена для комплексной оценки производительности торговых стратегий. Включает 40+ метрик, разделенных на категории по функциональности и важности.

## Категории метрик

### 1. Базовые метрики производительности

#### Total Profit
- **Описание**: Общая прибыль стратегии
- **Формула**: Сумма всех прибыльных сделок - сумма всех убыточных сделок
- **Единицы**: Абсолютная валюта
- **Важность**: Критическая

#### Profit In Pips
- **Описание**: Прибыль в пунктах (для валютных пар)
- **Формула**: Total Profit / (Lot Size * Pip Value)
- **Единицы**: Пункты
- **Важность**: Высокая

#### Yearly AVG Profit
- **Описание**: Средняя годовая прибыль
- **Формула**: Total Profit / (Период тестирования в годах)
- **Единицы**: Абсолютная валюта/год
- **Важность**: Высокая

#### Yearly AVG % Return
- **Описание**: Средняя годовая доходность в процентах
- **Формула**: (Yearly AVG Profit / Начальный капитал) * 100
- **Единицы**: Проценты
- **Важность**: Высокая

#### CAGR (Compound Annual Growth Rate)
- **Описание**: Сложная годовая ставка роста
- **Формула**: ((Конечный капитал / Начальный капитал)^(1/лет) - 1) * 100
- **Единицы**: Проценты
- **Важность**: Критическая

### 2. Метрики риска и доходности

#### Sharpe Ratio
- **Описание**: Отношение избыточной доходности к волатильности
- **Формула**: (Средняя доходность - Безрисковая ставка) / Стандартное отклонение доходности
- **Диапазон**: Обычно 0-3, >1 хорошо, >2 отлично
- **Важность**: Критическая

#### Profit Factor
- **Описание**: Отношение валовой прибыли к валовому убытку
- **Формула**: Gross Profit / |Gross Loss|
- **Диапазон**: >1.3 рекомендуется
- **Важность**: Критическая

#### Return/DD ratio
- **Описание**: Отношение доходности к максимальной просадке
- **Формула**: Total Return / Max Drawdown
- **Диапазон**: >2 хорошо, >3 отлично
- **Важность**: Высокая

#### Winning Percentage
- **Описание**: Процент прибыльных сделок
- **Формула**: (Количество прибыльных сделок / Общее количество сделок) * 100
- **Диапазон**: 40-60% типично
- **Важность**: Высокая

### 3. Метрики просадки

#### Draw Down
- **Описание**: Максимальная абсолютная просадка
- **Формула**: Максимальное падение от пика до минимума
- **Единицы**: Абсолютная валюта
- **Важность**: Критическая

#### % Draw Down
- **Описание**: Максимальная просадка в процентах
- **Формула**: (Draw Down / Максимальный капитал) * 100
- **Единицы**: Проценты
- **Важность**: Критическая

#### Max Consec Wins
- **Описание**: Максимальное количество последовательных прибыльных сделок
- **Единицы**: Количество сделок
- **Важность**: Средняя

#### Max Consec Losses
- **Описание**: Максимальное количество последовательных убыточных сделок
- **Единицы**: Количество сделок
- **Важность**: Высокая

### 4. Статистические метрики

#### R Expectancy
- **Описание**: Средняя ожидаемая прибыль с учетом риска
- **Формула**: (Win Rate * Avg Win) - (Loss Rate * Avg Loss)
- **Единицы**: Абсолютная валюта
- **Важность**: Высокая

#### R Expectancy Score
- **Описание**: R Expectancy с учетом частоты торговли
- **Формула**: R Expectancy * (Количество сделок в год / 100)
- **Единицы**: Нормализованная валюта
- **Важность**: Высокая

#### STR Quality Number (SQN)
- **Описание**: Качество торговой системы по Van Tharp
- **Формула**: (Expectancy / Стандартное отклонение) * sqrt(Количество сделок)
- **Интерпретация**:
  - 1.6-1.9: Ниже среднего, но торгуемо
  - 2.0-2.4: Среднее
  - 2.5-2.9: Хорошо
  - 3.0-5.0: Отлично
  - 5.1-6.9: Превосходно
  - 7.0+: Святой Грааль
- **Важность**: Критическая

#### SQN Score
- **Описание**: SQN с учетом длины тестирования
- **Формула**: SQN * sqrt(Период тестирования в годах)
- **Важность**: Высокая

### 5. Продвинутые метрики

#### Z-Score
- **Описание**: Стандартизированная оценка средней сделки
- **Формула**: (Average Trade - 0) / Стандартное отклонение сделок
- **Интерпретация**: >2 хорошо, >3 отлично
- **Важность**: Высокая

#### Z-Probability
- **Описание**: Вероятность получения положительной доходности
- **Формула**: 1 - P(Z < Z-Score)
- **Единицы**: Проценты
- **Важность**: Высокая

#### Expectancy
- **Описание**: Ожидаемая прибыль на сделку
- **Формула**: (Win Rate * Avg Win) - (Loss Rate * Avg Loss)
- **Единицы**: Абсолютная валюта
- **Важность**: Высокая

#### Deviation
- **Описание**: Стандартное отклонение доходности
- **Формула**: sqrt(Σ(Return - Mean Return)² / (n-1))
- **Единицы**: Абсолютная валюта
- **Важность**: Средняя

#### Exposure
- **Описание**: Процент времени в позиции
- **Формула**: (Время в позиции / Общее время) * 100
- **Единицы**: Проценты
- **Важность**: Средняя

### 6. Метрики симметрии и стабильности

#### Symmetry
- **Описание**: Сравнение прибыли по лонгам и шортам
- **Формула**: Long Profit / |Short Profit|
- **Интерпретация**: 1 = идеальная симметрия
- **Важность**: Средняя

#### Trades Symmetry
- **Описание**: Сравнение количества лонгов и шортов
- **Формула**: Long Trades / Short Trades
- **Интерпретация**: 1 = идеальная симметрия
- **Важность**: Низкая

#### NSymmetry
- **Описание**: Направленная симметрия прибыльности
- **Значения**:
  - -1: Лонги прибыльны, шорты убыточны (или наоборот)
  - 0: Оба направления прибыльны или убыточны
- **Важность**: Средняя

#### Stability
- **Описание**: Стабильность кривой капитала (линейная регрессия)
- **Формула**: R² от линейной регрессии кривой капитала
- **Диапазон**: 0-1, 1 = идеальная прямая линия
- **Важность**: Высокая

### 7. Метрики застоя

#### Stagnation In Days
- **Описание**: Максимальное количество дней без нового максимума
- **Единицы**: Дни
- **Важность**: Средняя

#### Stagnation In %
- **Описание**: Максимальный процент времени без нового максимума
- **Формула**: (Stagnation In Days / Общий период) * 100
- **Единицы**: Проценты
- **Важность**: Средняя

#### Gross Profit
- **Описание**: Общая валовая прибыль
- **Формула**: Сумма всех прибыльных сделок
- **Единицы**: Абсолютная валюта
- **Важность**: Высокая

#### Gross Loss
- **Описание**: Общий валовый убыток
- **Формула**: Сумма всех убыточных сделок
- **Единицы**: Абсолютная валюта
- **Важность**: Высокая

### 8. Дополнительные метрики

#### Average Win
- **Описание**: Средняя прибыльная сделка
- **Формула**: Gross Profit / Количество прибыльных сделок
- **Единицы**: Абсолютная валюта
- **Важность**: Высокая

#### Average Loss
- **Описание**: Средняя убыточная сделка
- **Формула**: |Gross Loss| / Количество убыточных сделок
- **Единицы**: Абсолютная валюта
- **Важность**: Высокая

#### Payout ratio
- **Описание**: Отношение средней прибыли к среднему убытку
- **Формула**: Average Win / Average Loss
- **Интерпретация**: >1 хорошо
- **Важность**: Высокая

#### AHPR (Average Holding Period Return)
- **Описание**: Средняя доходность за период удержания
- **Формула**: Среднее геометрическое доходности сделок
- **Единицы**: Проценты
- **Важность**: Средняя

#### Daily AVG Profit
- **Описание**: Средняя дневная прибыль
- **Формула**: Total Profit / Количество торговых дней
- **Единицы**: Абсолютная валюта/день
- **Важность**: Средняя

#### Monthly AVG Profit
- **Описание**: Средняя месячная прибыль
- **Формула**: Total Profit / Количество месяцев
- **Единицы**: Абсолютная валюта/месяц
- **Важность**: Средняя

#### Average Trade
- **Описание**: Средняя прибыль на сделку
- **Формула**: Total Profit / Общее количество сделок
- **Единицы**: Абсолютная валюта
- **Важность**: Высокая

#### Annual% / Max DD%
- **Описание**: Отношение годовой доходности к максимальной просадке
- **Формула**: (Yearly AVG % Return) / (% Draw Down)
- **Интерпретация**: >2 хорошо
- **Важность**: Высокая

#### Wins/Losses ratio
- **Описание**: Отношение количества прибыльных к убыточным сделкам
- **Формула**: Количество прибыльных сделок / Количество убыточных сделок
- **Интерпретация**: >1 хорошо
- **Важность**: Средняя

## Реализация в Rust

### Структура модулей

```rust
pub mod metrics {
    pub mod basic;           // Базовые метрики производительности
    pub mod risk_return;     // Метрики риска и доходности
    pub mod drawdown;        // Метрики просадки
    pub mod statistical;     // Статистические метрики
    pub mod advanced;        // Продвинутые метрики
    pub mod symmetry;        // Метрики симметрии и стабильности
    pub mod stagnation;      // Метрики застоя
    pub mod additional;      // Дополнительные метрики
    pub mod calculator;      // Основной калькулятор метрик
    pub mod report;          // Генерация отчетов
}
```

### Основные трейты

```rust
pub trait Metric {
    fn calculate(&self, trades: &[Trade]) -> f64;
    fn name(&self) -> &'static str;
    fn description(&self) -> &'static str;
}

pub trait MetricCalculator {
    fn calculate_all(&self, trades: &[Trade]) -> MetricReport;
    fn calculate_category(&self, trades: &[Trade], category: MetricCategory) -> CategoryReport;
}
```

### Примеры реализации

```rust
pub struct SharpeRatio {
    risk_free_rate: f64,
}

impl Metric for SharpeRatio {
    fn calculate(&self, trades: &[Trade]) -> f64 {
        let returns = trades.iter().map(|t| t.return_pct).collect::<Vec<_>>();
        let mean_return = returns.iter().sum::<f64>() / returns.len() as f64;
        let variance = returns.iter()
            .map(|r| (r - mean_return).powi(2))
            .sum::<f64>() / (returns.len() - 1) as f64;
        let std_dev = variance.sqrt();
        
        if std_dev == 0.0 { 0.0 } else { (mean_return - self.risk_free_rate) / std_dev }
    }
    
    fn name(&self) -> &'static str { "Sharpe Ratio" }
    fn description(&self) -> &'static str { 
        "Отношение избыточной доходности к волатильности" 
    }
}
```

## Приоритеты реализации

### Фаза 1 (Критическая)
1. Total Profit, CAGR, Sharpe Ratio, Profit Factor
2. Draw Down, % Draw Down, Winning Percentage
3. R Expectancy, SQN

### Фаза 2 (Высокая)
1. Return/DD ratio, Max Consec Losses
2. Z-Score, Z-Probability, Expectancy
3. Average Win, Average Loss, Payout ratio

### Фаза 3 (Средняя)
1. Stability, Symmetry, NSymmetry
2. Exposure, Deviation, AHPR
3. Stagnation метрики

### Фаза 4 (Низкая)
1. Trades Symmetry, Daily/Monthly AVG
2. Wins/Losses ratio, Max Consec Wins
3. Дополнительные метрики

## Интеграция с системой

### Связь с другими компонентами
- **Strategy Layer**: Получение данных о сделках
- **Risk Management**: Использование для оценки рисков
- **Optimization**: Использование как целевые функции
- **Reporting**: Генерация детальных отчетов

### Производительность
- **Кэширование**: Кэширование вычисленных метрик
- **Параллелизация**: Параллельное вычисление независимых метрик
- **Оптимизация**: SIMD для векторных операций
- **Инкрементальные обновления**: Обновление метрик при добавлении новых сделок
