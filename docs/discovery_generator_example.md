# Пример работы генератора стратегий

## Как генератор строит комбинации

Генератор строит **все возможные комбинации** стратегий через **декартово произведение** трех множеств:

1. **Комбинации таймфреймов**
2. **Комбинации индикаторов**
3. **Комбинации условий**

## Пример с конкретными данными

### Входные данные

```
Индикаторы: SMA, EMA, RSI (каждый с 1 параметром оптимизации)
Таймфреймы: базовый 60 минут, count=3 → [60, 120, 180]
Поля цены: Close, High, Low
Операторы: >, <, CrossesAbove
Макс. параметров оптимизации: 10 (включая стопы: стоп-лосс + тейк-профит = 2)
```

### Шаг 1: Комбинации таймфреймов

Генерируются все возможные комбинации из 3 таймфреймов:

```
Комбинация 1: [60]
Комбинация 2: [120]
Комбинация 3: [180]
Комбинация 4: [60, 120]
Комбинация 5: [60, 180]
Комбинация 6: [120, 180]
Комбинация 7: [60, 120, 180]
```

**Всего: 7 комбинаций**

### Шаг 2: Комбинации индикаторов

Доступно параметров оптимизации: 10 - 2 (стопы) = 8

Генерируются комбинации индикаторов с учетом ограничения:
- Каждый индикатор имеет 1 параметр оптимизации
- Максимум параметров = 8

```
Комбинация 1: [SMA] (1 параметр)
Комбинация 2: [EMA] (1 параметр)
Комбинация 3: [RSI] (1 параметр)
Комбинация 4: [SMA, EMA] (2 параметра)
Комбинация 5: [SMA, RSI] (2 параметра)
Комбинация 6: [EMA, RSI] (2 параметра)
Комбинация 7: [SMA, EMA, RSI] (3 параметра)
...
Комбинация N: [SMA, EMA, RSI, ...] (до 8 параметров)
```

**Всего: зависит от количества индикаторов**

### Шаг 3: Условия (индикатор-цена)

Генерируются все возможные комбинации условий между индикаторами и ценой:

```
Условие 1: SMA > Close
Условие 2: SMA > High
Условие 3: SMA > Low
Условие 4: SMA < Close
Условие 5: SMA < High
...
Условие 9: SMA CrossesAbove Close
Условие 10: SMA CrossesAbove High
...
Условие N: RSI CrossesAbove Low
```

**Всего:** 3 индикатора × 3 поля цены × 3 оператора = **27 условий**

### Шаг 4: Полная генерация стратегий

Для каждой комбинации (таймфреймы × индикаторы):
1. Фильтруются релевантные условия (которые используют индикаторы из текущей комбинации)
2. Генерируются все возможные комбинации условий (с учетом оставшихся параметров оптимизации)
3. Создается кандидат стратегии

**Пример для одной комбинации:**

```
Комбинация таймфреймов: [60, 120]
Комбинация индикаторов: [SMA, EMA]
Релевантные условия: 
  - SMA > Close, SMA > High, SMA < Close, ...
  - EMA > Close, EMA > High, EMA < Close, ...
  - SMA > EMA, SMA < EMA, SMA CrossesAbove EMA, ...

Комбинации условий:
  - []
  - [SMA > Close]
  - [SMA > Close, EMA > High]
  - [SMA > EMA]
  - ...
```

**Итоговое количество кандидатов:**

```
Кандидаты = TF_комбинации × Индикатор_комбинации × Условие_комбинации

Примерно:
7 (TF) × 7 (индикаторы) × ~50 (условия) = 2,450 кандидатов

Но на самом деле больше, т.к.:
- Каждая комбинация индикаторов имеет свои релевантные условия
- Генерируются разные комбинации условий (пустые, из 1 условия, из 2, и т.д.)
```

## Формула расчета

Для каждого кандидата стратегии:

```
Кандидат = {
    timeframes: [комбинация таймфреймов],
    indicators: [комбинация индикаторов],
    conditions: [комбинация условий],
}

Где:
- timeframes ∈ все_комбинации_таймфреймов
- indicators ∈ все_комбинации_индикаторов(с ограничением параметров)
- conditions ∈ все_комбинации_условий(релевантных для indicators, с ограничением параметров)
```

## Важные ограничения

1. **Максимальное количество параметров оптимизации**: Общее количество параметров индикаторов + условий + стопов не должно превышать заданное значение

2. **Релевантность условий**: Для каждой комбинации индикаторов используются только те условия, которые ссылаются на индикаторы из этой комбинации

3. **Валидация**: Каждый кандидат проверяется на соответствие ограничениям через `candidate.is_valid()`

## Пример вывода

```
Кандидат 1:
  Индикаторы: ["SMA", "EMA"]
  Условия: ["SMA > Close"]
  Таймфреймы: [Minutes(60), Minutes(120)]
  Параметров оптимизации: 3 (2 индикатора × 1 + 0 условий + 2 стопа)

Кандидат 2:
  Индикаторы: ["SMA", "EMA"]
  Условия: ["SMA > Close", "EMA > High"]
  Таймфреймы: [Minutes(60), Minutes(120)]
  Параметров оптимизации: 4 (2 индикатора × 1 + 0 условий + 2 стопа)

Кандидат 3:
  Индикаторы: ["RSI"]
  Условия: ["RSI > Close", "RSI < High"]
  Таймфреймы: [Minutes(180)]
  Параметров оптимизации: 4 (1 индикатор × 1 + 0 условий + 2 стопа)
```

## ⚠️ Внимание

Генератор создает **все возможные комбинации**, что может привести к **очень большому количеству кандидатов**:

```
7 таймфреймов × 100 индикаторов × 1000 условий = 700,000+ потенциальных кандидатов

С учетом фильтрации и ограничений это число может быть меньше, 
но все равно может быть очень большим!
```

Поэтому важно:
- Ограничивать количество доступных индикаторов
- Ограничивать количество таймфреймов
- Использовать фильтрацию условий
- Применять ограничения на количество параметров оптимизации

